<% node[:config_disclaimer].to_s.split("\n").each do |l| %>
# <%= l %>
<% end %>
#---

# This is the ssh client system-wide configuration file. 
# See sshd_config(5) for more information on any settings used. Comments will be added only to clarify why a configuration was chosen.
# 
# Created for OpenSSH v5.9

# Basic configuration
# ===================

# Either disable or only allow root login via certificates.
#PermitRootLogin no              
PermitRootLogin without-password

# Define which port sshd should listen to. Default to `22`.
<% @ssh_ports.each do |ssh_port| %>
Port <%= ssh_port %>
<% end %>

# Define which addresses sshd should listen to. Default to `0.0.0.0`, ie make sure you put your desired address in here, since otherwise sshd will listen to everyone.
<% @ssh_ips.each do |ssh_ip| %>
ListenAddress <%= ssh_ip %>
<% end %>

# Address family should always be limited to the active network configuration.
AddressFamily <%= @address_family %>

# If PAM is not configured, set this to `no`, otherwise `yes`.
UsePAM yes

# List HostKeys here.
<% @host_key_files.each do |host_key_file| %>
HostKey <%= host_key_file %>          # Req 20
<% end %>


# Security configuration
# ======================

# Set the protocol version to 2 for security reasons. Disables legacy support.
Protocol 2

# Make sure sshd checks file modes and ownership before accepting logins. This prevents accidental misconfiguration.
StrictModes yes

# Logging, obsoletes QuietMode and FascistLogging 
SyslogFacility AUTH
LogLevel VERBOSE

# Cryptography
# ------------

# **Ciphers** -- If your clients don't support CTR (eg older versions), cbc will be added
Ciphers aes128-ctr,aes256-ctr,aes192-ctr<% if @cbc_required == true %>,aes128-cbc,aes256-cbc,aes192-cbc<% end %>

# **Hash algorithms** -- Make sure not to use SHA1 for hashing, unless it is really necessary.
MACs hmac-sha2-256,hmac-sha2-512,hmac-ripemd160<% if @weak_hmac == true %>,hmac-sha1<% end %>

# Alternative setting, if OpenSSH version is below v5.9
#MACs hmac-ripemd160

# **Key Exchange Algorithms** -- Make sure not to use SHA1 for kex, unless it is really necessary
KexAlgorithms ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256<% if @weak_kex == true %>,diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1,diffie-hellman-group1-sha1<% end %>

# Lifetime and size of ephemeral version 1 server key
KeyRegenerationInterval 1h
ServerKeyBits 2048

# Authentication
# --------------

# Secure Login directives.
UseLogin no
UsePrivilegeSeparation yes
PermitUserEnvironment no
LoginGraceTime 30s
MaxAuthTries 2
MaxSessions 10

# Enable public key authentication
RSAAuthentication yes
PubkeyAuthentication yes

# Never use host-based authentication. It can be exploited.
IgnoreRhosts yes
IgnoreUserKnownHosts yes
RhostsRSAAuthentication no
HostbasedAuthentication no

# Disable password-based authentication, it can allow for potentially easier brute-force attacks.
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no

# Only enable Kerberos authentication if it is configured.
KerberosAuthentication no
KerberosOrLocalPasswd no
KerberosTicketCleanup yes
#KerberosGetAFSToken no

# Only enable GSSAPI authentication if it is configured.
GSSAPIAuthentication no
GSSAPICleanupCredentials yes

# In case you don't use PAM (`UsePAM no`), restrict users and groups here:
#DenyUsers *
#AllowUsers user1
#DenyGroups *
#AllowGroups group1


# Network
# -------

# TCP configuration.
TCPKeepAlive yes
ClientAliveInterval 900   # 15 minutes
ClientAliveCountMax 0

# Disable tunneling
PermitTunnel no

# Disable forwarding tcp connections.
AllowTcpForwarding no

# Do not allow remote port forwardings to bind to non-loopback addresses.
GatewayPorts no

# Disable X11 forwarding, since local X11 display could be accessed through forwarded connection.
X11Forwarding no
X11UseLocalhost yes

# Disable agent formwarding, since local agent could be accessed through forwarded connection.
AllowAgentForwarding no


# Misc. configuration
# ===================


PrintMotd no
PrintLastLog no
#Banner /etc/ssh/banner.txt
#UseDNS yes
#PidFile /var/run/sshd.pid
#MaxStartups 10
#ChrootDirectory none
#ChrootDirectory /home/%u

# Configuratoin, in case SFTP is used
## override default of no subsystems
## Subsystem sftp /opt/app/openssh5/libexec/sftp-server
#Subsystem sftp internal-sftp -l VERBOSE
# 
## These lines must appear at the *end* of sshd_config
#Match Group sftponly
#ForceCommand internal-sftp -l VERBOSE
#ChrootDirectory /sftpchroot/home/%u
#AllowTcpForwarding no
#AllowAgentForwarding no
#PasswordAuthentication no
#PermitRootLogin no
#X11Forwarding no


